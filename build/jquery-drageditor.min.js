(function(t,e,n){function o(e){this.target=t(e)}o.prototype={constructor:o,setXY:function(t,e){this.x=parseInt(t)||1;this.y=parseInt(e)||1;return this},setTargetCss:function(e){t(this.target).css(e);return this}};function r(){this.x=1;this.y=1}r.prototype.setXY=function(t,e){this.x=parseInt(t);this.y=parseInt(e)};var s;var a={dragElement:null,dragDom:null,settings:null,targetType:true,targetDom:null,endFuncall:null,mouse:new r};var i={dragging:{cursor:"move"},defaults:{cursor:"default"}};var l=t(document);var u;l.bind("mousemove",function(t){u=g(t||e.event)}).bind("selectstart",function(t){t.stopPropagation();return false});function g(t){if(t.pageX||t.pageY){return{x:t.pageX,y:t.pageY}}return{x:t.clientX+document.body.scrollLeft-document.body.clientLeft,y:t.clientY+document.body.scrollTop-document.body.clientTop}}function f(t,e){var n=d(t);if(e.x>n.right||e.x<n.left){return false}if(e.y>n.bottom||e.y<n.top){return false}return true}function d(e,o){e=t(e);o=o===n?e.offset():o;return{top:o.top,bottom:o.top+e.height(),left:o.left,right:o.left+e.width()}}function c(e,r){var u={dragSel:null,dragSelOn:true,dragCss:"",target:{select:null,targetType:true,css:"",tarSelCss:"",dragOkCss:""},clone:false,onClone:null,onStart:function(t){},onEnd:function(t){}};var g=t.extend(true,{},u,r);s=t.extend(true,{},a);l.mousemove(p).mouseleave(m).mouseup(m);var f;var d;var c;if(g.dragSel===null){c=e;c.on({mousedown:h})}else{if(g.dragSelOn){e.find(g.dragSel).on("mousedown",h)}else{e.delegate(g.dragSel,"mousedown",h)}}function h(e){var r=t(this);if(document.attachEvent){r[0].attachEvent("onselectstart",function(){return false})}r.find("img").bind("dragstart",function(){return false});if(g.clone){r=t(r.clone(false));var l={width:t(this).width(),height:t(this).height()};if(g.onClone){r=t(g.onClone(r,l))}else{r.css(l)}}r.addClass(g.dragCss);r.css({position:"fixed",zIndex:99999,top:e.clientY,left:e.clientX});if(g.clone){r.insertAfter(t(this))}g.onStart&&g.onStart({div:r,parent:t(this),mouseEvent:e});r.on({mouseup:m,mouseover:function(){t(this).css(i.dragging)},mouseout:function(){t(this).css(i.defaults)}});var u=s.dragElement=new o(r);f=t(u.target);s.dragDom=r;s.settings=g;if(g.target.select!==null){s.targetDom=t(g.target.select)}s.mouse.setXY(e.clientX,e.clientY);var c={x:f.position().left,y:f.position().top};s.dragElement.setXY(c.x,c.y);function m(e){if(f!==null)f.removeClass(g.dragCss);r.unbind("mouseup");r.unbind("mouseout");r.unbind("mouseover");r.css(i.defaults);if(s.targetDom!==null){if(s.settings.target.targetType){t(s.targetDom).append(r.clone());r.remove()}else{var o=s.targetDomNow;if(o!==null&&o!==n){var l=r.clone();l.css({width:"auto",height:"auto",position:null,opacity:1,"z-index":null,cursor:"default"});o.append(l)}s.targetDom.removeClass(s.settings.target.tarSelCss);r.remove()}}s=t.extend(true,{},a);g.onEnd&&g.onEnd({div:r,parent:t(this),mouseEvent:e,target:d})}s.endFuncall=m;p(e)}}function m(){if(s!==n&&typeof s.endFuncall==="function"){s.endFuncall()}}function p(e){if(s.dragElement&&s.settings!==null){var n=s.mouse,o=s.dragElement;var r=parseInt(e.clientX-n.x+o.x);var a=parseInt(e.clientY-n.y+o.y);if(s.targetDom!==null&&s.targetDom.length>0){if(s.settings.target.targetType){var i=d(s.targetDom);var l=d(s.dragDom,{top:a,left:r});if(l.left<i.left){r=i.left}if(l.right>i.right){r=i.right-s.dragDom.width()}if(l.top<i.top){a=i.top}if(l.bottom>i.bottom){a=i.bottom-s.dragDom.height()}}else{s.targetDom.removeClass(s.settings.target.tarSelCss);s.targetDomNow=null;for(var g=0;g<s.targetDom.length;g++){var c=t(s.targetDom[g]);if(f(c,u)){c.addClass(s.settings.target.tarSelCss);s.targetDomNow=c}}}}o.setTargetCss({left:r+"px",top:a+"px"})}}t.fn.kisDrag=function(t){c(this,t)}})(jQuery,window,undefined);